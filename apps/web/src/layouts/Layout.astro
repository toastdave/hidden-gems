---
import "../styles/globals.css";
import { ModeToggle } from "../components/mode-toggle";
import { Button } from "../components/ui/button";
import { apiServerBase, fetchApiJson } from "../lib/api";

interface Props {
  title?: string;
}

const { title = "Hidden Gems" } = Astro.props;
const isDiscoverPage = Astro.url.pathname === "/";
const initialSearchQuery = Astro.url.searchParams.get("q") ?? "";
const initialRadius = Astro.url.searchParams.get("radius") ?? "";
const initialType = Astro.url.searchParams.get("type") ?? "";
const initialSort = Astro.url.searchParams.get("sort") ?? "nearby";
const sessionResult = await fetchApiJson<{ user: { email?: string } | null }>(
  `${apiServerBase}/api/auth/get-session`,
  {
    headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
  },
);
const currentUser = sessionResult.data?.user ?? null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script is:inline>
      const getThemePreference = () => {
        if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
          return localStorage.getItem("theme");
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      };
      const isDark = getThemePreference() === "dark";
      document.documentElement.classList[isDark ? "add" : "remove"]("dark");

      if (typeof localStorage !== "undefined") {
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
      }
    </script>
  </head>
  <body class="app-shell min-h-screen bg-background text-foreground antialiased">
    <header class="sticky top-0 z-30 border-b bg-background">
      <div class="mx-auto grid w-full max-w-screen-2xl grid-cols-[auto,1fr,auto] items-center gap-3 px-4 py-3 sm:gap-4 sm:px-6 lg:px-8">
        <a href="/" class="flex items-center gap-2">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-primary text-xs font-bold text-primary-foreground">
            HG
          </span>
          <span class="text-sm font-semibold tracking-[0.04em]">Hidden Gems</span>
        </a>

        {
          isDiscoverPage ? (
            <div class="col-span-3 order-3 md:order-none md:col-span-1 md:justify-self-center md:w-full md:max-w-5xl">
              <div class="flex flex-wrap items-center gap-2 rounded-2xl border bg-card p-2 shadow-sm">
                <div class="flex h-10 min-w-[220px] flex-1 items-center gap-2 rounded-full border bg-background px-3">
                  <svg class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M21 21l-4.35-4.35m1.85-5.15a7 7 0 11-14 0 7 7 0 0114 0z"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    ></path>
                  </svg>
                  <input
                    id="listing-search"
                    data-listing-search
                    name="q"
                    type="search"
                    value={initialSearchQuery}
                    placeholder="Search neighborhood or keyword"
                    class="h-full w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground"
                  />
                </div>

                <select id="listing-radius" class="h-10 rounded-full border bg-background px-3 text-sm">
                  <option value="" selected={initialRadius === ""}>Any distance</option>
                  <option value="25" selected={initialRadius === "25"}>25 mi</option>
                  <option value="50" selected={initialRadius === "50"}>50 mi</option>
                  <option value="100" selected={initialRadius === "100"}>100 mi</option>
                  <option value="250" selected={initialRadius === "250"}>250 mi</option>
                </select>

                <select id="listing-type" class="h-10 rounded-full border bg-background px-3 text-sm">
                  <option value="" selected={initialType === ""}>All types</option>
                  <option value="event" selected={initialType === "event"}>Event</option>
                  <option value="activity" selected={initialType === "activity"}>Activity</option>
                  <option value="place" selected={initialType === "place"}>Place</option>
                </select>

                <select id="listing-sort" class="h-10 rounded-full border bg-background px-3 text-sm">
                  <option value="nearby" selected={initialSort === "nearby"}>Nearby</option>
                  <option value="newest" selected={initialSort === "newest"}>Newest</option>
                  <option value="a-z" selected={initialSort === "a-z"}>Title A-Z</option>
                </select>

                <div class="inline-flex rounded-full border p-1">
                  <button class="view-toggle rounded-full px-3 py-1 text-xs font-medium" data-view="split" type="button">Split</button>
                  <button class="view-toggle rounded-full px-3 py-1 text-xs font-medium" data-view="list" type="button">List</button>
                  <button class="view-toggle rounded-full px-3 py-1 text-xs font-medium" data-view="map" type="button">Map</button>
                </div>
              </div>
            </div>
          ) : (
            <form action="/" method="get" class="hidden items-center justify-self-center md:flex md:w-full md:max-w-xl">
              <div class="flex h-11 w-full items-center gap-2 rounded-full border bg-card px-3 shadow-sm transition focus-within:border-primary/60 focus-within:shadow">
                <svg class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M21 21l-4.35-4.35m1.85-5.15a7 7 0 11-14 0 7 7 0 0114 0z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  ></path>
                </svg>
                <input
                  id="listing-search"
                  data-listing-search
                  name="q"
                  type="search"
                  value={initialSearchQuery}
                  placeholder="Start your search"
                  class="h-full w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground"
                />
                <Button type="submit" size="sm">Search</Button>
              </div>
            </form>
          )
        }

        <div class="flex items-center gap-2">
          {currentUser ? (
            <details class="group relative">
              <summary class="list-none">
                <Button variant="outline" size="sm" type="button">
                  {currentUser.email?.split("@")[0] ?? "Account"}
                </Button>
              </summary>
              <div class="absolute right-0 mt-2 w-44 space-y-1 rounded-xl border bg-card p-2 shadow-lg">
                <a class="block rounded-md px-3 py-2 text-sm hover:bg-muted" href="/account">Account settings</a>
                <a class="block rounded-md px-3 py-2 text-sm hover:bg-muted" href="/billing">Plan and billing</a>
                <a class="block rounded-md px-3 py-2 text-sm hover:bg-muted" href="/saved">Saved and alerts</a>
                <a class="block rounded-md px-3 py-2 text-sm hover:bg-muted" href="/auth">Sign out / session</a>
              </div>
            </details>
          ) : (
            <Button size="sm" asChild><a href="/auth">Sign in</a></Button>
          )}
          <ModeToggle client:load />
        </div>

        {
          !isDiscoverPage ? (
            <form action="/" method="get" class="col-span-3 flex items-center md:hidden">
              <div class="flex h-10 w-full items-center gap-2 rounded-full border bg-card px-3 shadow-sm">
                <svg class="h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M21 21l-4.35-4.35m1.85-5.15a7 7 0 11-14 0 7 7 0 0114 0z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  ></path>
                </svg>
                <input
                  id="listing-search-mobile"
                  data-listing-search
                  name="q"
                  type="search"
                  value={initialSearchQuery}
                  placeholder="Start your search"
                  class="h-full w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground"
                />
              </div>
            </form>
          ) : null
        }
      </div>
    </header>
    <main class="mx-auto w-full max-w-screen-2xl px-4 py-6 sm:px-6 lg:px-8">
      <slot />
    </main>

    <dialog id="auth-modal" class="w-[min(92vw,480px)] rounded-2xl border border-white/60 bg-card p-0 text-foreground shadow-2xl backdrop:bg-black/50 dark:border-white/10">
      <div class="space-y-4 p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.12em] text-primary">Sign in required</p>
            <h2 class="mt-1 text-2xl">Save and personalize your discovery.</h2>
            <p id="auth-modal-message" class="mt-2 text-sm text-muted-foreground">
              Create an account to save listings, manage alerts, and unlock premium controls.
            </p>
          </div>
          <button id="auth-modal-close" type="button" class="inline-flex h-8 w-8 items-center justify-center rounded-md border text-sm hover:bg-secondary">X</button>
        </div>

        <div class="grid gap-2 sm:grid-cols-2">
          <a href="/auth" class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground">
            Continue with email
          </a>
          <a href="/auth" class="inline-flex h-10 items-center justify-center rounded-md border px-4 text-sm font-medium hover:bg-secondary">
            Continue with Google
          </a>
        </div>

        <p class="text-xs text-muted-foreground">You can still browse listings and the map without signing in.</p>
      </div>
    </dialog>

    <script is:inline>
      const authModal = document.getElementById("auth-modal");
      const authModalMessage = document.getElementById("auth-modal-message");
      const authModalClose = document.getElementById("auth-modal-close");

      const openAuthModal = (message) => {
        if (!authModal) return;
        if (authModalMessage && message) {
          authModalMessage.textContent = message;
        }
        if (typeof authModal.showModal === "function") {
          authModal.showModal();
        } else {
          window.location.href = "/auth";
        }
      };

      window.addEventListener("open-auth-modal", (event) => {
        const message = event?.detail?.message;
        openAuthModal(message);
      });

      authModalClose?.addEventListener("click", () => {
        authModal?.close();
      });

      authModal?.addEventListener("click", (event) => {
        const rect = authModal.getBoundingClientRect();
        const inside =
          event.clientX >= rect.left &&
          event.clientX <= rect.right &&
          event.clientY >= rect.top &&
          event.clientY <= rect.bottom;
        if (!inside) {
          authModal.close();
        }
      });
    </script>
  </body>
</html>
