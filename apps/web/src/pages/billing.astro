---
import { Alert, AlertDescription, AlertTitle } from "../components/ui/alert";
import { Badge } from "../components/ui/badge";
import { Button } from "../components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "../components/ui/card";
import Layout from "../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../lib/api";

const apiBase = apiServerBase;
const plansResult = await fetchApiJson<{ plans: Array<Record<string, unknown>> }>(
  `${apiBase}/billing/plans`,
);
const plansData = plansResult.data ?? { plans: [] };
const statusResult = await fetchApiJson<Record<string, unknown>>(`${apiBase}/billing/status`, {
  headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
});
const status = statusResult.data;
---

<Layout title="Billing | Hidden Gems">
  <Card>
    <CardHeader><CardTitle>Billing and Entitlements</CardTitle></CardHeader>
    <CardContent class="space-y-3">
      {!plansResult.ok ? (
        <Alert variant="destructive">
          <AlertTitle>API unavailable</AlertTitle>
          <AlertDescription>{plansResult.error}</AlertDescription>
        </Alert>
      ) : null}
      <div class="flex items-center gap-2">
        <span class="text-sm text-muted-foreground">Current status</span>
        <Badge variant={status?.premium ? "default" : "outline"}>
          {status?.premium ? "Premium" : "Free / unauthenticated"}
        </Badge>
      </div>
      <pre class="rounded-md border bg-muted p-3 text-xs">{JSON.stringify(status, null, 2)}</pre>
    </CardContent>
  </Card>

  <Card>
    <CardHeader><CardTitle class="text-lg">Plans</CardTitle></CardHeader>
    <CardContent class="space-y-3">
      {plansData.plans.map((plan: any) => (
        <div class="rounded-md border p-3">
          <p class="font-medium">{plan.name}</p>
          <p class="text-sm text-muted-foreground">${(plan.priceMonthly / 100).toFixed(2)} / month</p>
          <p class="text-xs text-muted-foreground">Slug: {plan.slug}</p>
          <Button class="checkout-button mt-3" size="sm" data-plan-slug={plan.slug}>
            Upgrade via Checkout
          </Button>
        </div>
      ))}
      <pre id="billing-output" class="rounded-md border bg-muted p-3 text-xs"></pre>
    </CardContent>
  </Card>

  <script is:inline define:vars={{ apiClientBase }}>
    const output = document.getElementById("billing-output");
    const setOutput = (value) => (output.textContent = JSON.stringify(value, null, 2));
    for (const button of document.querySelectorAll(".checkout-button")) {
      button.addEventListener("click", async () => {
        const planSlug = button.getAttribute("data-plan-slug");
        const response = await fetch(`${apiClientBase}/billing/checkout`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ planSlug }),
        });
        const data = await response.json();
        setOutput(data);
        if (data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        }
      });
    }
  </script>
</Layout>
