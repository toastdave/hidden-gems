---
import type { Listing } from "@hidden-gems/shared";
import { DiscoveryMap } from "../components/discovery-map";
import Layout from "../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../lib/api";

const apiBase = apiServerBase;
const feedResult = await fetchApiJson<{ listings: Listing[] }>(`${apiBase}/listings/feed?limit=20`);
const listings = Array.isArray(feedResult.data?.listings) ? feedResult.data.listings : [];
const meResult = await fetchApiJson<{ user: { email?: string } | null }>(
  `${apiBase}/api/auth/get-session`,
  {
    headers: {
      cookie: Astro.request.headers.get("cookie") ?? "",
    },
  },
);
const me = meResult.data ?? { user: null };
---

<Layout title="Hidden Gems | Discover">
  {!feedResult.ok ? <p class="mb-4 rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700">API unavailable: {feedResult.error}</p> : null}

  <section id="discover-shell" class="grid gap-4 lg:grid-cols-2">
    <div id="listing-column" class="space-y-3 lg:max-h-[calc(100vh-9.5rem)] lg:overflow-y-auto lg:pr-2">
      <p id="listing-count" class="text-sm text-muted-foreground"></p>
      <div id="listing-results" class="space-y-2.5">
        {
          listings.map((listing: any) => (
            <article
              class="listing-card group grid cursor-pointer overflow-hidden rounded-xl border border-white/70 bg-card shadow-sm transition hover:-translate-y-0.5 hover:shadow-md dark:border-white/10 sm:grid-cols-[32%,minmax(0,1fr)]"
              data-id={listing.id}
              data-title={listing.title ?? ""}
              data-location={listing.locationText ?? ""}
              data-type={listing.type ?? ""}
              data-created={listing.createdAt ?? ""}
              data-lat={listing.lat ?? ""}
              data-lng={listing.lng ?? ""}
              data-url={`/listings/${listing.id}`}
            >
              <img
                src={listing.coverImageUrl ?? `https://picsum.photos/seed/${listing.id}/640/420`}
                alt={listing.title ?? "Listing photo"}
                loading="lazy"
                class="h-20 w-full object-cover sm:h-full"
              />
              <div class="space-y-1.5 p-2.5 sm:p-3">
                <div class="flex items-start justify-between gap-2">
                  <h3 class="line-clamp-1 text-sm font-semibold">{listing.title}</h3>
                  <span class="rounded-full bg-secondary px-2 py-1 text-xs font-medium">{listing.type}</span>
                </div>
                <p class="line-clamp-1 text-xs text-muted-foreground">{listing.locationText ?? "Location pending"}</p>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="rounded-full border px-2 py-0.5 text-[11px]">{listing.status}</span>
                </div>
                <div class="flex flex-wrap items-center gap-1.5 pt-0.5">
                  <a
                    href={`/listings/${listing.id}`}
                    class="inline-flex h-7 items-center justify-center rounded-md border px-2.5 text-[11px] font-medium transition hover:bg-secondary"
                  >
                    View details
                  </a>
                  <button
                    type="button"
                    class="map-focus inline-flex h-7 items-center justify-center rounded-md border px-2.5 text-[11px] font-medium transition hover:bg-secondary"
                  >
                    Show on map
                  </button>
                  <button
                    type="button"
                    class="favorite-toggle inline-flex h-7 items-center justify-center rounded-md bg-secondary px-2.5 text-[11px] font-medium"
                    data-listing-id={listing.id}
                  >
                    Save
                  </button>
                </div>
              </div>
            </article>
          ))
        }
      </div>
      {
        listings.length === 0 ? (
          <div class="rounded-xl border bg-card px-4 py-6 text-sm text-muted-foreground">No listings published yet.</div>
        ) : null
      }
    </div>

    <aside id="map-column" class="lg:sticky lg:top-24">
      <div class="h-[46vh] overflow-hidden rounded-2xl border border-white/70 bg-card shadow-sm dark:border-white/10 lg:h-[calc(100vh-9.5rem)]">
        <DiscoveryMap client:load apiBase={apiClientBase} />
      </div>
    </aside>
  </section>

  <script is:inline define:vars={{ apiClientBase, isAuthenticated: Boolean(me.user) }}>
    const cards = Array.from(document.querySelectorAll(".listing-card"));
    const listingResults = document.getElementById("listing-results");
    const listingCount = document.getElementById("listing-count");
    const searchInputs = Array.from(document.querySelectorAll("[data-listing-search]"));
    const radiusSelect = document.getElementById("listing-radius");
    const typeSelect = document.getElementById("listing-type");
    const sortSelect = document.getElementById("listing-sort");

    let userLocation = null;

    const distanceKm = (lat1, lng1, lat2, lng2) => {
      const earth = 6371;
      const dLat = ((lat2 - lat1) * Math.PI) / 180;
      const dLng = ((lng2 - lng1) * Math.PI) / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos((lat1 * Math.PI) / 180) *
          Math.cos((lat2 * Math.PI) / 180) *
          Math.sin(dLng / 2) *
          Math.sin(dLng / 2);
      return earth * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    };

    const setCount = () => {
      const visible = cards.filter((card) => card.style.display !== "none").length;
      listingCount.textContent = `${visible} listing${visible === 1 ? "" : "s"} shown`;
    };

    const applyFilters = () => {
      const query = searchInputs
        .map((input) => (input instanceof HTMLInputElement ? input.value.trim().toLowerCase() : ""))
        .find(Boolean) || "";
      const selectedType = typeSelect.value;
      const selectedRadiusMiles = Number(radiusSelect.value || "0");
      const selectedRadiusKm = selectedRadiusMiles > 0 ? selectedRadiusMiles * 1.60934 : 0;

      for (const card of cards) {
        const title = (card.dataset.title || "").toLowerCase();
        const location = (card.dataset.location || "").toLowerCase();
        const type = card.dataset.type || "";
        const lat = Number(card.dataset.lat || "");
        const lng = Number(card.dataset.lng || "");
        const matchesQuery = !query || title.includes(query) || location.includes(query);
        const matchesType = !selectedType || type === selectedType;

        let matchesRadius = true;
        if (selectedRadiusKm > 0 && userLocation) {
          const canMeasure = Number.isFinite(lat) && Number.isFinite(lng);
          if (!canMeasure) {
            matchesRadius = false;
          } else {
            const distance = distanceKm(userLocation.lat, userLocation.lng, lat, lng);
            matchesRadius = distance <= selectedRadiusKm;
          }
        }

        card.style.display = matchesQuery && matchesType && matchesRadius ? "" : "none";
      }

      const sorted = [...cards].sort((a, b) => {
        if (sortSelect.value === "nearby") {
          if (!userLocation) {
            return 0;
          }
          const aLat = Number(a.dataset.lat);
          const aLng = Number(a.dataset.lng);
          const bLat = Number(b.dataset.lat);
          const bLng = Number(b.dataset.lng);
          const aDistance = Number.isFinite(aLat) && Number.isFinite(aLng)
            ? distanceKm(userLocation.lat, userLocation.lng, aLat, aLng)
            : Number.POSITIVE_INFINITY;
          const bDistance = Number.isFinite(bLat) && Number.isFinite(bLng)
            ? distanceKm(userLocation.lat, userLocation.lng, bLat, bLng)
            : Number.POSITIVE_INFINITY;
          return aDistance - bDistance;
        }
        if (sortSelect.value === "a-z") {
          return (a.dataset.title || "").localeCompare(b.dataset.title || "");
        }
        return (b.dataset.created || "").localeCompare(a.dataset.created || "");
      });

      for (const card of sorted) {
        listingResults.appendChild(card);
      }

      setCount();
    };

    for (const input of searchInputs) {
      if (!(input instanceof HTMLInputElement)) continue;
      input.addEventListener("input", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
          return;
        }
        for (const otherInput of searchInputs) {
          if (otherInput instanceof HTMLInputElement && otherInput !== target) {
            otherInput.value = target.value;
          }
        }
        applyFilters();
      });
    }
    radiusSelect.addEventListener("change", applyFilters);
    typeSelect.addEventListener("change", applyFilters);
    sortSelect.addEventListener("change", applyFilters);
    applyFilters();

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          radiusSelect.value = "50";
          sortSelect.value = "nearby";
          applyFilters();
          window.dispatchEvent(
            new CustomEvent("focus-user-location", {
              detail: {
                lat: userLocation.lat,
                lng: userLocation.lng,
              },
            }),
          );
        },
        () => {
          // leave default sorting if location permission is denied
        },
        { timeout: 7000 },
      );
    }

    const mapColumn = document.getElementById("map-column");
    const listingColumn = document.getElementById("listing-column");
    const shell = document.getElementById("discover-shell");
    const toggles = document.querySelectorAll(".view-toggle");

    const setSelectedCard = (selectedId) => {
      for (const card of cards) {
        const active = card.getAttribute("data-id") === selectedId;
        card.classList.toggle("ring-2", active);
        card.classList.toggle("ring-primary/60", active);
      }
      if (!selectedId) return;
      const selectedCard = cards.find((card) => card.getAttribute("data-id") === selectedId);
      if (selectedCard) {
        selectedCard.scrollIntoView({ block: "nearest", behavior: "smooth" });
      }
    };

    const setActiveToggle = (activeView) => {
      for (const button of toggles) {
        const isActive = button.getAttribute("data-view") === activeView;
        button.classList.toggle("bg-primary", isActive);
        button.classList.toggle("text-primary-foreground", isActive);
      }
    };

    const setView = (view) => {
      if (view === "map") {
        shell.className = "grid gap-4";
        listingColumn.style.display = "none";
        mapColumn.style.display = "block";
      } else if (view === "list") {
        shell.className = "grid gap-4";
        listingColumn.style.display = "block";
        mapColumn.style.display = "none";
      } else {
        shell.className = "grid gap-4 lg:grid-cols-2";
        listingColumn.style.display = "block";
        mapColumn.style.display = "block";
      }
      setActiveToggle(view);
      localStorage.setItem("discover-view", view);
    };

    for (const button of toggles) {
      button.addEventListener("click", () => setView(button.getAttribute("data-view") || "split"));
    }

    const savedView = localStorage.getItem("discover-view") || "split";
    setView(savedView);

    const promptSignin = () => {
      window.dispatchEvent(
        new CustomEvent("open-auth-modal", {
          detail: { message: "Sign in to save listings, create alerts, and track discoveries." },
        }),
      );
    };

    const buttons = document.querySelectorAll(".favorite-toggle");
    for (const button of buttons) {
      button.addEventListener("click", async () => {
        if (!isAuthenticated) {
          promptSignin();
          return;
        }
        const listingId = button.getAttribute("data-listing-id");
        const response = await fetch(`${apiClientBase}/favorites/toggle`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ listingId }),
        });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        button.textContent = data.favorited ? "Saved" : "Save";
      });
    }

    for (const card of cards) {
      card.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof Element && target.closest("a, button")) {
          return;
        }
        setSelectedCard(card.getAttribute("data-id"));
        const targetUrl = card.getAttribute("data-url");
        if (targetUrl) {
          window.location.href = targetUrl;
        }
      });
    }

    const focusButtons = document.querySelectorAll(".map-focus");
    for (const button of focusButtons) {
      button.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;
        const card = target.closest(".listing-card");
        if (!card) return;
        const lat = Number(card.getAttribute("data-lat"));
        const lng = Number(card.getAttribute("data-lng"));
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        setSelectedCard(card.getAttribute("data-id"));
        setView("split");
        window.dispatchEvent(
          new CustomEvent("focus-listing-on-map", {
            detail: {
              id: card.getAttribute("data-id"),
              title: card.getAttribute("data-title") || "Listing",
              locationText: card.getAttribute("data-location") || null,
              lat,
              lng,
            },
          }),
        );
      });
    }

    window.addEventListener("listing-selected-on-map", (event) => {
      const customEvent = event;
      const selectedId = customEvent?.detail?.id;
      if (selectedId) {
        setSelectedCard(String(selectedId));
      }
    });
  </script>
</Layout>
