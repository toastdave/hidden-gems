---
import Layout from "../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../lib/api";

const sessionResult = await fetchApiJson<{ user: { email?: string } | null }>(
  `${apiServerBase}/api/auth/get-session`,
  {
    headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
  },
);
const currentUser = sessionResult.data?.user ?? null;
---

<Layout title="Sign In | Hidden Gems">
  <section class="mb-5 rounded-2xl border border-white/50 bg-card/85 p-5 shadow-sm backdrop-blur dark:border-white/10 dark:bg-card/80 sm:p-7">
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-primary">Account access</p>
    <h1 class="mt-2 text-3xl sm:text-4xl">Save listings. Follow alerts. Unlock premium tools.</h1>
    <p class="mt-3 max-w-2xl text-sm text-muted-foreground sm:text-base">
      Browsing discovery is always free with no login. Sign in only when you want to save, track, and personalize your experience.
    </p>
  </section>

  <section class="grid gap-4 lg:grid-cols-[1.2fr,1fr]">
    <article class="rounded-2xl border border-white/60 bg-card p-4 shadow-sm dark:border-white/10">
      <div class="mb-4 inline-flex rounded-lg border p-1 text-sm">
        <button class="auth-tab rounded-md px-3 py-1.5 font-medium" data-target="signin-panel">Sign in</button>
        <button class="auth-tab rounded-md px-3 py-1.5 font-medium" data-target="signup-panel">Create account</button>
      </div>

      <div id="signin-panel" class="auth-panel space-y-3">
        <p class="text-sm text-muted-foreground">Welcome back. Continue to your saved lists and alerts.</p>
        <form id="login-form" class="space-y-3">
          <input
            id="login-email"
            name="email"
            type="email"
            placeholder="Email"
            required
            class="h-11 w-full rounded-md border border-input bg-background px-3 text-sm"
          />
          <input
            id="login-password"
            name="password"
            type="password"
            placeholder="Password"
            required
            class="h-11 w-full rounded-md border border-input bg-background px-3 text-sm"
          />
          <button type="submit" class="inline-flex h-11 w-full items-center justify-center rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground">
            Sign in
          </button>
        </form>
      </div>

      <div id="signup-panel" class="auth-panel hidden space-y-3">
        <p class="text-sm text-muted-foreground">Create an account to save favorites, alerts, and premium settings.</p>
        <form id="signup-form" class="space-y-3">
          <input
            id="signup-email"
            name="email"
            type="email"
            placeholder="Email"
            required
            class="h-11 w-full rounded-md border border-input bg-background px-3 text-sm"
          />
          <input
            id="signup-password"
            name="password"
            type="password"
            placeholder="Password (min 8 chars)"
            minlength="8"
            required
            class="h-11 w-full rounded-md border border-input bg-background px-3 text-sm"
          />
          <input
            id="signup-display-name"
            name="displayName"
            type="text"
            placeholder="Display name (optional)"
            class="h-11 w-full rounded-md border border-input bg-background px-3 text-sm"
          />
          <button type="submit" class="inline-flex h-11 w-full items-center justify-center rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground">
            Create account
          </button>
        </form>
      </div>

      <div class="my-4 h-px bg-border"></div>

      <button id="google-signin" type="button" class="inline-flex h-11 w-full items-center justify-center rounded-md border px-4 text-sm font-medium transition hover:bg-secondary">
        Continue with Google
      </button>

      <pre id="auth-output" class="mt-4 max-h-44 overflow-auto rounded-md border bg-muted p-3 text-xs"></pre>
    </article>

    <article class="space-y-4 rounded-2xl border border-white/60 bg-card p-4 shadow-sm dark:border-white/10">
      <div class="rounded-xl border bg-background/70 p-4">
        <h2 class="text-xl">Current account</h2>
        <p class="mt-2 text-sm text-muted-foreground">
          {currentUser ? (
            <>
              Signed in as <span class="font-medium text-foreground">{currentUser.email ?? "member"}</span>
            </>
          ) : (
            "You are currently browsing as a guest."
          )}
        </p>
        <div class="mt-3 flex flex-wrap gap-2">
          <a href="/" class="inline-flex h-9 items-center justify-center rounded-md border px-3 text-sm font-medium transition hover:bg-secondary">Go to discover</a>
          <a href="/saved" class="inline-flex h-9 items-center justify-center rounded-md border px-3 text-sm font-medium transition hover:bg-secondary">Open saved</a>
        </div>
      </div>

      <div class="rounded-xl border bg-background/70 p-4">
        <h3 class="text-lg">Free vs Premium</h3>
        <ul class="mt-2 space-y-1 text-sm text-muted-foreground">
          <li>- Free: browse listings and map instantly.</li>
          <li>- Account: save favorites and alerts.</li>
          <li>- Premium: deeper filters and creator growth tools.</li>
        </ul>
      </div>

      <div class="flex gap-2">
        <button id="refresh-session" type="button" class="inline-flex h-10 flex-1 items-center justify-center rounded-md border px-3 text-sm font-medium transition hover:bg-secondary">
          Refresh session
        </button>
        <button id="logout-button" type="button" class="inline-flex h-10 flex-1 items-center justify-center rounded-md border px-3 text-sm font-medium transition hover:bg-secondary">
          Sign out
        </button>
      </div>
    </article>
  </section>

  <script is:inline define:vars={{ apiBase: apiClientBase }}>
    const output = document.getElementById("auth-output");
    const setOutput = (data) => (output.textContent = JSON.stringify(data, null, 2));

    const requestJson = async (url, options = {}) => {
      try {
        const response = await fetch(url, options);
        const data = await response.json().catch(() => null);
        return { ok: response.ok, status: response.status, data };
      } catch (error) {
        return {
          ok: false,
          status: 0,
          data: { error: error instanceof Error ? error.message : "Unable to connect to API service." },
        };
      }
    };

    const tabs = document.querySelectorAll(".auth-tab");
    const panels = document.querySelectorAll(".auth-panel");
    const setActiveTab = (target) => {
      for (const tab of tabs) {
        const active = tab.getAttribute("data-target") === target;
        tab.classList.toggle("bg-primary", active);
        tab.classList.toggle("text-primary-foreground", active);
      }
      for (const panel of panels) {
        panel.classList.toggle("hidden", panel.id !== target);
      }
    };

    for (const tab of tabs) {
      tab.addEventListener("click", () => setActiveTab(tab.getAttribute("data-target") || "signin-panel"));
    }
    setActiveTab("signin-panel");

    async function submitForm(formId, endpoint) {
      const form = document.getElementById(formId);
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        if (endpoint === "/api/auth/sign-up/email") {
          payload.name = payload.displayName || payload.email?.split?.("@")[0] || "User";
          delete payload.displayName;
        }
        const response = await requestJson(`${apiBase}${endpoint}`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload),
        });
        setOutput(response.data);
        if (response.ok) {
          setTimeout(() => {
            window.location.href = "/saved";
          }, 350);
        }
      });
    }

    submitForm("signup-form", "/api/auth/sign-up/email");
    submitForm("login-form", "/api/auth/sign-in/email");

    document.getElementById("logout-button").addEventListener("click", async () => {
      const response = await requestJson(`${apiBase}/api/auth/sign-out`, {
        method: "POST",
        credentials: "include",
      });
      setOutput(response.data);
      if (response.ok) {
        setTimeout(() => {
          window.location.reload();
        }, 350);
      }
    });

    document.getElementById("refresh-session").addEventListener("click", async () => {
      const response = await requestJson(`${apiBase}/api/auth/get-session`, {
        credentials: "include",
      });
      setOutput(response.data);
    });

    document.getElementById("google-signin").addEventListener("click", () => {
      const callbackURL = `${window.location.origin}/saved`;
      window.location.href = `${apiBase}/api/auth/sign-in/social?provider=google&callbackURL=${encodeURIComponent(callbackURL)}`;
    });
  </script>
</Layout>
