---
import { Alert, AlertDescription, AlertTitle } from "../components/ui/alert";
import { Badge } from "../components/ui/badge";
import { Button } from "../components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "../components/ui/card";
import { Input } from "../components/ui/input";
import Layout from "../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../lib/api";

const apiBase = apiServerBase;
const result = await fetchApiJson<{ alerts: Array<Record<string, unknown>> }>(`${apiBase}/alerts`, {
  headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
});
const data = result.data ?? { alerts: [] };
---

<Layout title="Saved Alerts | Hidden Gems">
  <Card>
    <CardHeader><CardTitle>Saved Search Alerts</CardTitle></CardHeader>
    <CardContent class="space-y-3">
      <form id="new-alert-form" class="grid gap-3 md:grid-cols-[1fr,1fr,auto]">
        <Input name="radiusKm" type="number" min="1" max="500" placeholder="Radius (km)" required />
        <select
          name="type"
          class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        >
          <option value="">Any type</option>
          <option value="event">Event</option>
          <option value="place">Place</option>
          <option value="activity">Activity</option>
        </select>
        <Button type="submit">Create Alert</Button>
      </form>
      <Button id="run-worker" type="button" variant="outline">Run Alert Worker Skeleton</Button>
      <pre id="alerts-output" class="rounded-md border bg-muted p-3 text-xs"></pre>
    </CardContent>
  </Card>

  <Card>
    <CardHeader><CardTitle class="text-lg">Existing Alerts</CardTitle></CardHeader>
    <CardContent class="space-y-3">
      {!result.ok ? (
        <Alert variant="destructive">
          <AlertTitle>Unable to load alerts</AlertTitle>
          <AlertDescription>{result.error ?? "Login required."}</AlertDescription>
        </Alert>
      ) : data.alerts.length === 0 ? (
        <p class="text-sm text-muted-foreground">No saved alerts yet.</p>
      ) : (
        data.alerts.map((alert: any) => (
          <div class="rounded-md border p-3">
            <p class="text-xs text-muted-foreground">ID: {alert.id}</p>
            <div class="mt-2 flex items-center gap-2">
              <Badge variant="secondary">Radius: {alert.radiusKm}km</Badge>
              <Badge variant={alert.enabled ? "default" : "outline"}>
                {alert.enabled ? "Enabled" : "Disabled"}
              </Badge>
            </div>
            <Button
              class="toggle-alert mt-3"
              size="sm"
              variant="outline"
              data-alert-id={alert.id}
              data-current-enabled={String(alert.enabled)}
            >
              Toggle
            </Button>
          </div>
        ))
      )}
    </CardContent>
  </Card>

  <script is:inline define:vars={{ apiClientBase }}>
    const output = document.getElementById("alerts-output");
    const setOutput = (value) => (output.textContent = JSON.stringify(value, null, 2));

    const form = document.getElementById("new-alert-form");
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const payload = {
        radiusKm: Number(data.radiusKm),
        filters: data.type ? { type: data.type } : {},
      };
      const response = await fetch(`${apiClientBase}/alerts`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });
      setOutput(await response.json());
    });

    for (const button of document.querySelectorAll(".toggle-alert")) {
      button.addEventListener("click", async () => {
        const alertId = button.getAttribute("data-alert-id");
        const current = button.getAttribute("data-current-enabled") === "true";
        const response = await fetch(`${apiClientBase}/alerts/${alertId}`, {
          method: "PATCH",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ enabled: !current }),
        });
        setOutput(await response.json());
      });
    }

    document.getElementById("run-worker").addEventListener("click", async () => {
      const response = await fetch(`${apiClientBase}/alerts/worker/run`, { method: "POST" });
      setOutput(await response.json());
    });
  </script>
</Layout>
