---
import { LocationPicker } from "../components/location-picker";
import { Alert, AlertDescription, AlertTitle } from "../components/ui/alert";
import { Button } from "../components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "../components/ui/card";
import { Input } from "../components/ui/input";
import { Label } from "../components/ui/label";
import Layout from "../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../lib/api";

type Profile = {
  id: string;
  email: string;
  displayName: string | null;
  avatarUrl: string | null;
  homeLat: number | null;
  homeLng: number | null;
};

const sessionResult = await fetchApiJson<{ user: { email?: string } | null }>(
  `${apiServerBase}/api/auth/get-session`,
  {
    headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
  },
);

const profileResult = sessionResult.data?.user
  ? await fetchApiJson<{ profile: Profile }>(`${apiServerBase}/users/me`, {
      headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
    })
  : null;

const profile = profileResult?.data?.profile ?? null;
const currentUser = sessionResult.data?.user ?? null;
---

<Layout title="Account Settings | Hidden Gems">
  <section class="mb-5 rounded-2xl border border-white/50 bg-card/85 p-5 shadow-sm backdrop-blur dark:border-white/10 dark:bg-card/80 sm:p-7">
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-primary">Account settings</p>
    <h1 class="mt-2 text-3xl sm:text-4xl">Profile and home location</h1>
    <p class="mt-3 max-w-2xl text-sm text-muted-foreground sm:text-base">
      Keep your profile up to date and save a default location to improve nearby discovery.
    </p>
  </section>

  {!currentUser ? (
    <Alert variant="destructive">
      <AlertTitle>Sign in required</AlertTitle>
      <AlertDescription>
        You need to sign in before you can edit your account. <a href="/auth" class="underline">Go to sign in</a>.
      </AlertDescription>
    </Alert>
  ) : null}

  {currentUser && !profile ? (
    <Alert variant="destructive">
      <AlertTitle>Unable to load profile</AlertTitle>
      <AlertDescription>{profileResult?.error ?? "Unable to fetch your profile."}</AlertDescription>
    </Alert>
  ) : null}

  {profile ? (
    <div class="grid gap-4 lg:grid-cols-[1fr,1.2fr]">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Avatar</CardTitle>
          <CardDescription>Upload an image to personalize your account.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          <div class="flex items-center gap-3">
            {profile.avatarUrl ? (
              <img id="avatar-preview" src={profile.avatarUrl} alt="Avatar" class="h-16 w-16 rounded-full border object-cover" />
            ) : (
              <div
                id="avatar-preview-fallback"
                class="flex h-16 w-16 items-center justify-center rounded-full border bg-muted text-sm text-muted-foreground"
              >
                No avatar
              </div>
            )}
            <div class="text-sm text-muted-foreground">
              Signed in as <span class="font-medium text-foreground">{profile.email}</span>
            </div>
          </div>

          <form id="avatar-form" class="space-y-3">
            <Input
              id="avatar-file"
              name="avatar"
              type="file"
              accept="image/png,image/jpeg,image/webp,image/avif"
              required
            />
            <Button type="submit">Upload avatar</Button>
          </form>
          <p id="avatar-status" class="text-xs text-muted-foreground"></p>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Profile</CardTitle>
          <CardDescription>Edit your display name and saved home location.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          <form id="profile-form" class="space-y-3">
            <div class="space-y-1">
              <Label htmlFor="display-name">Display name</Label>
              <Input id="display-name" name="displayName" type="text" maxLength={80} value={profile.displayName ?? ""} />
            </div>

            <div class="space-y-1">
              <Label>Home location</Label>
              <LocationPicker
                client:load
                initialLat={profile.homeLat ?? undefined}
                initialLng={profile.homeLng ?? undefined}
                initialAddress=""
              />
            </div>

            <div class="flex flex-wrap gap-2">
              <Button type="submit">Save profile</Button>
              <Button id="profile-clear-location" type="button" variant="secondary">Clear location</Button>
            </div>
          </form>
          <p id="profile-status" class="text-xs text-muted-foreground"></p>
        </CardContent>
      </Card>
    </div>
  ) : null}

  <script is:inline define:vars={{ apiBase: apiClientBase }}>
    const profileForm = document.getElementById("profile-form");
    const profileStatus = document.getElementById("profile-status");
    const profileClearLocation = document.getElementById("profile-clear-location");
    const avatarForm = document.getElementById("avatar-form");
    const avatarStatus = document.getElementById("avatar-status");
    const avatarFileInput = document.getElementById("avatar-file");

    const setStatus = (el, message, error = false) => {
      if (!el) return;
      el.textContent = message;
      el.className = error ? "text-xs text-destructive" : "text-xs text-muted-foreground";
    };

    const requestJson = async (url, options = {}) => {
      try {
        const response = await fetch(url, options);
        const data = await response.json().catch(() => null);
        return { ok: response.ok, status: response.status, data };
      } catch (error) {
        return {
          ok: false,
          status: 0,
          data: { error: error instanceof Error ? error.message : "Unable to connect to API service." },
        };
      }
    };

    if (profileClearLocation && profileForm) {
      profileClearLocation.addEventListener("click", () => {
        const latInput = profileForm.querySelector('input[name="lat"]');
        const lngInput = profileForm.querySelector('input[name="lng"]');
        const locationTextInput = profileForm.querySelector('input[name="locationText"]');
        if (latInput instanceof HTMLInputElement) {
          latInput.value = "";
        }
        if (lngInput instanceof HTMLInputElement) {
          lngInput.value = "";
        }
        if (locationTextInput instanceof HTMLInputElement) {
          locationTextInput.value = "";
        }
        const numericInputs = profileForm.querySelectorAll('input[type="number"]');
        numericInputs.forEach((input) => {
          if (input instanceof HTMLInputElement) {
            input.value = "";
            input.dispatchEvent(new Event("input", { bubbles: true }));
          }
        });
      });
    }

    if (profileForm) {
      profileForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(profileForm);
        const displayName = String(formData.get("displayName") ?? "").trim();
        const latRaw = String(formData.get("lat") ?? "").trim();
        const lngRaw = String(formData.get("lng") ?? "").trim();

        const payload = {
          displayName,
          homeLat: latRaw ? Number(latRaw) : null,
          homeLng: lngRaw ? Number(lngRaw) : null,
        };

        const response = await requestJson(`${apiBase}/users/me`, {
          method: "PATCH",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          setStatus(profileStatus, response.data?.error ?? "Unable to save profile.", true);
          return;
        }

        setStatus(profileStatus, "Profile saved.");
      });
    }

    async function uploadToSignedUrl(url, file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("PUT", url);
        xhr.setRequestHeader("content-type", file.type);
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve(undefined);
            return;
          }
          reject(new Error(`Upload failed with status ${xhr.status}`));
        };
        xhr.onerror = () => reject(new Error("Upload request failed."));
        xhr.send(file);
      });
    }

    if (avatarForm && avatarFileInput instanceof HTMLInputElement) {
      avatarForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const file = avatarFileInput.files?.[0];
        if (!file) {
          setStatus(avatarStatus, "Choose an image first.", true);
          return;
        }

        setStatus(avatarStatus, "Preparing upload...");
        const uploadResponse = await requestJson(`${apiBase}/users/me/avatar/upload-url`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            fileName: file.name,
            contentType: file.type,
            sizeBytes: file.size,
          }),
        });

        if (!uploadResponse.ok) {
          setStatus(avatarStatus, uploadResponse.data?.error ?? "Unable to start avatar upload.", true);
          return;
        }

        try {
          await uploadToSignedUrl(uploadResponse.data.upload.uploadUrl, file);
        } catch {
          setStatus(avatarStatus, "Avatar upload failed.", true);
          return;
        }

        const completeResponse = await requestJson(`${apiBase}/users/me/avatar/complete`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            objectKey: uploadResponse.data.upload.objectKey,
            contentType: file.type,
          }),
        });

        if (!completeResponse.ok) {
          setStatus(avatarStatus, completeResponse.data?.error ?? "Unable to finalize avatar.", true);
          return;
        }

        const nextAvatarUrl = completeResponse.data?.profile?.avatarUrl;
        if (nextAvatarUrl) {
          const existingImage = document.getElementById("avatar-preview");
          if (existingImage instanceof HTMLImageElement) {
            existingImage.src = nextAvatarUrl;
          } else {
            window.location.reload();
            return;
          }
        }

        avatarFileInput.value = "";
        setStatus(avatarStatus, "Avatar updated.");
      });
    }
  </script>
</Layout>
