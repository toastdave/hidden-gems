---
import { DiscoveryMap } from "../../components/discovery-map";
import Layout from "../../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../../lib/api";

const sessionResult = await fetchApiJson<{ user: { email?: string } | null }>(
  `${apiServerBase}/api/auth/get-session`,
  {
    headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
  },
);
const currentUser = sessionResult.data?.user ?? null;
---

<Layout title="Map Discovery | Hidden Gems">
  <section class="mb-4 rounded-2xl border border-white/50 bg-card/85 p-5 shadow-sm backdrop-blur dark:border-white/10 dark:bg-card/80 sm:p-7">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
      <div class="space-y-2">
        <p class="text-xs font-semibold uppercase tracking-[0.14em] text-primary">Map mode</p>
        <h1 class="text-3xl sm:text-4xl">Explore the map first, then drill into listings.</h1>
        <p class="max-w-2xl text-sm text-muted-foreground sm:text-base">
          Pan and zoom to discover nearby hidden gems. Click any pin for a quick preview and jump to details.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-2 text-xs">
        <a href="/" class="rounded-full border px-3 py-1 transition hover:bg-secondary">Back to split view</a>
        {currentUser ? (
          <a href="/saved" class="rounded-full border px-3 py-1 transition hover:bg-secondary">Saved and alerts</a>
        ) : (
          <a href="/auth" class="rounded-full border px-3 py-1 transition hover:bg-secondary">Sign in to save</a>
        )}
      </div>
    </div>
  </section>

  <section class="overflow-hidden rounded-2xl border border-white/70 bg-card shadow-sm dark:border-white/10">
    <DiscoveryMap client:load apiBase={apiClientBase} />
  </section>
</Layout>
