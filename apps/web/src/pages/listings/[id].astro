---
import Layout from "../../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../../lib/api";

const listingId = Astro.params.id;
const result = await fetchApiJson<{ listing: Record<string, any> }>(`${apiServerBase}/listings/${listingId}`, {
  headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
});
const listing = result.data?.listing ?? null;
---

<Layout title="Listing Detail | Hidden Gems">
  {
    !result.ok || !listing ? (
      <section class="rounded-xl border border-red-300 bg-red-50 p-4 text-red-700">
        <h1 class="text-xl">Listing not found</h1>
        <p class="mt-1 text-sm">{result.error}</p>
      </section>
    ) : (
      <>
        <section class="rounded-2xl border border-white/60 bg-card p-5 shadow-sm dark:border-white/10">
          <div class="space-y-3">
            <h1 class="text-3xl">{listing.title}</h1>
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <span class="rounded-full bg-secondary px-3 py-1">{listing.type}</span>
              <span class="rounded-full border px-3 py-1">{listing.status}</span>
            </div>
            <p class="text-sm text-muted-foreground">Location: {listing.locationText ?? "No location set"}</p>
            <div class="flex flex-wrap items-center gap-2">
              <button
                id="favorite-toggle"
                type="button"
                data-listing-id={listing.id}
                class="inline-flex h-10 items-center justify-center rounded-md bg-secondary px-4 text-sm font-medium"
              >
                Save Listing
              </button>
              <a
                href="/"
                class="inline-flex h-10 items-center justify-center rounded-md border px-4 text-sm font-medium transition hover:bg-secondary"
              >
                Back to discover
              </a>
            </div>
          </div>
        </section>

        <section class="mt-4 rounded-2xl border border-white/60 bg-card p-5 shadow-sm dark:border-white/10">
          <h2 class="text-2xl">Report Listing</h2>
          <form id="report-form" class="mt-3 space-y-3">
            <input type="hidden" name="listingId" value={listing.id} />
            <input
              name="reason"
              type="text"
              placeholder="Reason"
              required
              class="h-10 w-full rounded-md border border-input bg-background px-3 text-sm"
            />
            <textarea
              name="details"
              rows="3"
              placeholder="Optional details"
              class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
            ></textarea>
            <button type="submit" class="inline-flex h-10 items-center justify-center rounded-md border px-4 text-sm font-medium transition hover:bg-secondary">
              Submit report
            </button>
          </form>
          <pre id="listing-detail-output" class="mt-3 max-h-44 overflow-auto rounded-md border bg-muted p-3 text-xs"></pre>
        </section>
      </>
    )
  }

  <script is:inline define:vars={{ apiClientBase }}>
    const output = document.getElementById("listing-detail-output");
    const setOutput = (value) => {
      if (output) {
        output.textContent = JSON.stringify(value, null, 2);
      }
    };

    const favoriteButton = document.getElementById("favorite-toggle");
    if (favoriteButton) {
      favoriteButton.addEventListener("click", async () => {
        const listingId = favoriteButton.getAttribute("data-listing-id");
        const response = await fetch(`${apiClientBase}/favorites/toggle`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ listingId }),
        });
        if (response.status === 401) {
          window.dispatchEvent(
            new CustomEvent("open-auth-modal", {
              detail: { message: "Sign in to save this listing and get alerts when similar spots appear." },
            }),
          );
          return;
        }
        if (!response.ok) {
          setOutput({ error: "Unable to update saved state right now." });
          return;
        }
        const data = await response.json();
        favoriteButton.textContent = data.favorited ? "Saved" : "Save Listing";
        setOutput(data);
      });
    }

    const reportForm = document.getElementById("report-form");
    if (reportForm) {
      reportForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = Object.fromEntries(new FormData(reportForm).entries());
        const response = await fetch(`${apiClientBase}/reports`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload),
        });
        setOutput(await response.json());
      });
    }
  </script>
</Layout>
