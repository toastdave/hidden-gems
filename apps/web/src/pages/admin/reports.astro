---
import { Alert, AlertDescription, AlertTitle } from "../../components/ui/alert";
import { Badge } from "../../components/ui/badge";
import { Button } from "../../components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "../../components/ui/card";
import Layout from "../../layouts/Layout.astro";
import { apiClientBase, apiServerBase, fetchApiJson } from "../../lib/api";

const apiBase = apiServerBase;
const result = await fetchApiJson<{ reports: Array<Record<string, unknown>> }>(
  `${apiBase}/admin/reports`,
  {
    headers: { cookie: Astro.request.headers.get("cookie") ?? "" },
  },
);
const data = result.data ?? { reports: [] };
---

<Layout title="Moderation | Hidden Gems">
  <Card>
    <CardHeader>
      <CardTitle>Admin Reports</CardTitle>
    </CardHeader>
    <CardContent class="space-y-3">
      <p class="text-sm text-muted-foreground">
        Requires an admin email listed in `ADMIN_EMAILS` env var.
      </p>
      <pre id="moderation-output" class="rounded-md border bg-muted p-3 text-xs"></pre>
    </CardContent>
  </Card>

  <Card>
    <CardHeader><CardTitle class="text-lg">Report Queue</CardTitle></CardHeader>
    <CardContent class="space-y-3">
      {!result.ok ? (
        <Alert variant="destructive">
          <AlertTitle>Unable to load reports</AlertTitle>
          <AlertDescription>{result.error ?? "Unauthorized"}</AlertDescription>
        </Alert>
      ) : (
        data.reports.map((entry: any) => (
          <div class="rounded-md border p-3">
            <p class="font-medium">{entry.listing.title}</p>
            <p class="mt-1 text-sm text-muted-foreground">Reason: {entry.report.reason}</p>
            <p class="text-sm text-muted-foreground">Reported by: {entry.reporter.email}</p>
            <div class="mt-2 flex items-center gap-2">
              <Badge variant={entry.report.status === "reviewed" ? "secondary" : "destructive"}>
                {entry.report.status}
              </Badge>
              <Button class="mark-reviewed" size="sm" variant="outline" data-report-id={entry.report.id}>
                Mark Reviewed
              </Button>
            </div>
          </div>
        ))
      )}
    </CardContent>
  </Card>

  <script is:inline define:vars={{ apiClientBase }}>
    const output = document.getElementById("moderation-output");
    const setOutput = (value) => (output.textContent = JSON.stringify(value, null, 2));
    for (const button of document.querySelectorAll(".mark-reviewed")) {
      button.addEventListener("click", async () => {
        const reportId = button.getAttribute("data-report-id");
        const response = await fetch(`${apiClientBase}/admin/reports/${reportId}`, {
          method: "PATCH",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ status: "reviewed" }),
        });
        setOutput(await response.json());
      });
    }
  </script>
</Layout>
